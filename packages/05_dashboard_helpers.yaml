# Dashboard Helpers - Sensoren en helpers voor dashboard visualisatie
# Alleen de echt gebruikte helpers, geen placeholders

template:
  - sensor:
      # Energie flow visualisatie
      - name: "Grid Flow Direction"
        unique_id: grid_flow_direction
        state: >
          {% set import = states('sensor.eth_dongle_pro_power_delivered') | float(0) %}
          {% set export = states('sensor.eth_dongle_pro_power_returned') | float(0) %}
          {% if import > export %}
            importing
          {% elif export > import %}
            exporting
          {% else %}
            neutral
          {% endif %}
        icon: >
          {% if is_state('sensor.grid_flow_direction', 'importing') %}
            mdi:transmission-tower-import
          {% elif is_state('sensor.grid_flow_direction', 'exporting') %}
            mdi:transmission-tower-export
          {% else %}
            mdi:transmission-tower
          {% endif %}
        attributes:
          import_power: "{{ states('sensor.eth_dongle_pro_power_delivered') | float(0) }}"
          export_power: "{{ states('sensor.eth_dongle_pro_power_returned') | float(0) }}"
          net_power: "{{ states('sensor.house_net_power') | float(0) }}"
          
      # Dashboard statistieken
      - name: "Daggemiddelde Verbruik"
        unique_id: daily_average_consumption
        unit_of_measurement: kWh
        device_class: energy
        state: >
          {% set hours = now().hour + (now().minute / 60) %}
          {% if hours > 0 %}
            {% set daily = states('sensor.electricity_consumption_daily') | float(0) %}
            {{ ((daily / hours) * 24) | round(1) }}
          {% else %}
            0
          {% endif %}
          
      # Capaciteit percentage voor gauge
      - name: "Capaciteit Percentage"
        unique_id: capacity_percentage
        unit_of_measurement: "%"
        state: >
          {% set current = states('sensor.house_net_power') | float(0) %}
          {% set limit = states('sensor.fluvius_capacity_limit') | float(1) %}
          {{ ((current / limit) * 100) | round(1) }}
        attributes:
          severity: >
            {% set pct = states('sensor.capacity_percentage') | float(0) %}
            {% if pct < 70 %}
              green
            {% elif pct < 90 %}
              yellow
            {% else %}
              red
            {% endif %}
            
      # EV Laadsnelheid helper
      - name: "EV Laadsnelheid km/h"
        unique_id: ev_charging_speed_kmh
        unit_of_measurement: "km/h"
        state: >
          {% set power = states('sensor.ev_estimated_power') | float(0) / 1000 %}
          {% set efficiency = 5.5 %}  # km per kWh voor Kia EV3
          {{ (power * efficiency) | round(1) }}
        icon: mdi:speedometer
        availability: >
          {{ states('sensor.ev_estimated_power') | float(0) > 100 }}
          
      # Tijd tot volgende piek reset
      - name: "Dagen Tot Piek Reset"
        unique_id: days_until_peak_reset
        unit_of_measurement: "dagen"
        state: >
          {% set peak_date = state_attr('sensor.home_import_power_peak_31d', 'last_reset') %}
          {% if peak_date %}
            {% set reset_date = as_timestamp(peak_date) + (31 * 86400) %}
            {% set days_left = ((reset_date - as_timestamp(now())) / 86400) %}
            {{ [days_left, 0] | max | round(0) }}
          {% else %}
            31
          {% endif %}
          
      # Vandaag vs gisteren vergelijking
      - name: "Verbruik Trend"
        unique_id: consumption_trend
        state: >
          {% set today = states('sensor.electricity_consumption_daily') | float(0) %}
          {% set hours = now().hour + (now().minute / 60) %}
          {% set today_projected = (today / hours * 24) if hours > 0 else 0 %}
          {% set yesterday = state_attr('sensor.energy_delivered_daily', 'last_period') | float(today_projected) %}
          
          {% if today_projected > yesterday * 1.1 %}
            Hoger dan gisteren
          {% elif today_projected < yesterday * 0.9 %}
            Lager dan gisteren
          {% else %}
            Gelijk aan gisteren
          {% endif %}
        icon: >
          {% if 'Hoger' in states('sensor.consumption_trend') %}
            mdi:trending-up
          {% elif 'Lager' in states('sensor.consumption_trend') %}
            mdi:trending-down
          {% else %}
            mdi:trending-neutral
          {% endif %}
          
      # Kosten per uur schatting
      - name: "Kosten Per Uur"
        unique_id: cost_per_hour
        unit_of_measurement: "â‚¬/h"
        device_class: monetary
        state: >
          {% set power = states('sensor.house_net_power') | float(0) / 1000 %}
          {% set price = states('input_number.electricity_energy_price') | float(0.25) %}
          {{ (power * price) | round(2) }}
          
  - binary_sensor:
      # Dashboard waarschuwingen
      - name: "Hoog Verbruik Waarschuwing"
        unique_id: high_consumption_warning
        device_class: problem
        state: >
          {% set current = states('sensor.house_net_power') | float(0) %}
          {% set average = states('sensor.daggemiddelde_verbruik') | float(2000) %}
          {{ current > average * 2 }}
          
      # Slimme apparaten actief
      - name: "Zware Apparaten Actief"
        unique_id: heavy_appliances_active
        device_class: running
        state: >
          {% set dishwasher = states('sensor.vaatwas_power') | float(0) > 100 %}
          {% set washing = states('sensor.metered_wall_plug_switch_power') | float(0) > 100 %}
          {% set dryer = states('sensor.droogkast_power') | float(0) > 100 %}
          {{ dishwasher or washing or dryer }}
        attributes:
          active_appliances: >
            {% set appliances = [] %}
            {% if states('sensor.vaatwas_power') | float(0) > 100 %}
              {% set appliances = appliances + ['Vaatwasser'] %}
            {% endif %}
            {% if states('sensor.metered_wall_plug_switch_power') | float(0) > 100 %}
              {% set appliances = appliances + ['Wasmachine'] %}
            {% endif %}
            {% if states('sensor.droogkast_power') | float(0) > 100 %}
              {% set appliances = appliances + ['Droogkast'] %}
            {% endif %}
            {{ appliances | join(', ') }}
            
# Dashboard specifieke automatiseringen
automation:
  # Update dashboard bij significante wijzigingen
  - alias: "Dashboard Refresh Trigger"
    id: dashboard_refresh_trigger
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.capacity_percentage
      - platform: state
        entity_id: binary_sensor.new_month_peak_warning
        to: "on"
    condition:
      - condition: template
        value_template: >
          {% set old = trigger.from_state.state | float(0) %}
          {% set new = trigger.to_state.state | float(0) %}
          {{ (new - old) | abs > 5 }}
    action:
      # Fire event voor dashboard refresh
      - event: dashboard_refresh_needed
        event_data:
          reason: "{{ trigger.entity_id }}"
          
# Input helpers voor dashboard controle
input_boolean:
  dashboard_animations:
    name: Dashboard animaties
    initial: true
    icon: mdi:animation
    
  dashboard_detailed_view:
    name: Gedetailleerde weergave
    initial: false
    icon: mdi:information
    
  dashboard_show_predictions:
    name: Toon voorspellingen
    initial: true
    icon: mdi:crystal-ball
    
input_select:
  dashboard_theme:
    name: Dashboard thema
    options:
      - Auto
      - Light
      - Dark
      - Energy
    initial: Auto
    icon: mdi:palette