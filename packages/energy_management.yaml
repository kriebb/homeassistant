# /config/packages/energy_management.yaml
# Complete Energy & Capacity Management Package

# ========================================
# INPUT NUMBERS - Capacity Limits
# ========================================
input_number:
  # Overall capacity limits
  max_house_power:
    name: "Maximum huisverbruik (W)"
    min: 1000
    max: 8000
    step: 100
    initial: 4000
    unit_of_measurement: "W"
    icon: mdi:flash

  capacity_warning_threshold:
    name: "Waarschuwingsdrempel (W)"
    min: 3000
    max: 5000
    step: 100
    initial: 4200
    unit_of_measurement: "W"
    icon: mdi:flash-alert

  capacity_critical_threshold:
    name: "Kritieke drempel (W)"
    min: 4000
    max: 6000
    step: 100
    initial: 4400
    unit_of_measurement: "W"
    icon: mdi:flash-red-eye

  # Appliance power settings
  washing_machine_power_usage:
    name: "Wasmachine verbruik (W)"
    min: 1500
    max: 2500
    step: 50
    initial: 2200
    unit_of_measurement: "W"
    icon: mdi:washing-machine

  dryer_power_usage:
    name: "Droogkast verbruik (W)"
    min: 2000
    max: 3500
    step: 50
    initial: 2800
    unit_of_measurement: "W"
    icon: mdi:tumble-dryer

  dishwasher_power_usage:
    name: "Vaatwasser verbruik (W)"
    min: 1800
    max: 2500
    step: 50
    initial: 2000
    unit_of_measurement: "W"
    icon: mdi:dishwasher

# ========================================
# INPUT BOOLEANS - Control Switches
# ========================================
input_boolean:
  # Capacity protection
  capacity_protection_active:
    name: "Capaciteitsbescherming actief"
    initial: true
    icon: mdi:shield-check

  washing_machine_interrupted:
    name: "Wasmachine onderbroken"
    initial: false
    icon: mdi:washing-machine-alert
    
  dryer_interrupted:
    name: "Droogkast onderbroken"  
    initial: false
    icon: mdi:tumble-dryer-alert

  # Appliance auto modes
  washing_machine_auto_mode:
    name: "Wasmachine automatisch beheer"
    initial: true
    icon: mdi:auto-mode

  washing_machine_cycle_active:
    name: "Wasmachine cyclus actief"
    initial: false
    icon: mdi:washing-machine

  dryer_auto_mode:
    name: "Droogkast automatisch beheer"
    initial: true
    icon: mdi:auto-mode

  dryer_cycle_active:
    name: "Droogkast cyclus actief"
    initial: false
    icon: mdi:tumble-dryer

  dishwasher_auto_mode:
    name: "Vaatwasser automatisch beheer"
    initial: true
    icon: mdi:auto-mode

  dishwasher_cycle_active:
    name: "Vaatwasser cyclus actief"
    initial: false
    icon: mdi:dishwasher

  # Wachtrij management
  wasmachine_wachtrij:
    name: "Wasmachine in Wachtrij"
    icon: mdi:washing-machine
    initial: false
    
  droogkast_wachtrij:
    name: "Droogkast in Wachtrij"
    icon: mdi:tumble-dryer
    initial: false
    
  vaatwasser_wachtrij:
    name: "Vaatwasser in Wachtrij"
    icon: mdi:dishwasher
    initial: false
    
  piek_blokkering:
    name: "Piek Tarief Blokkering"
    icon: mdi:flash-alert
    initial: false

# ========================================
# INPUT SELECT - Tariff Selection
# ========================================
input_select:
  electricity_tariff_block:
    name: "Elektriciteitstarief"
    options:
      - piek
      - dal
      - superdal
    initial: dal
    icon: mdi:cash-clock

# ========================================
# TEMPLATE SENSORS
# ========================================
template:
  - sensor:
      # Available power capacity
      - name: "Beschikbaar vermogen"
        unique_id: available_power_capacity
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set max_power = states('input_number.max_house_power') | float(4000) %}
          {% set current_power = states('sensor.eth_dongle_pro_power_delivered') | float(0) %}
          {{ (max_power - current_power) | round(0) }}
        icon: mdi:flash-outline

      # Fluvius tariff sensor
      - name: "Fluvius Tarief"
        unique_id: fluvius_tarief
        state: >
          {% set now = now() %}
          {% set weekday = now.weekday() %}
          {% set hour = now.hour %}
          {% if weekday < 5 %}
            {% if hour >= 1 and hour < 7 or hour >= 11 and hour < 17 or hour >= 22 %}
              Dal
            {% else %}
              Piek
            {% endif %}
          {% else %}
            {% if hour >= 7 and hour < 11 %}
              Super Dal
            {% elif hour >= 0 and hour < 7 or hour >= 11 and hour < 17 %}
              Dal
            {% else %}
              Piek
            {% endif %}
          {% endif %}
        icon: mdi:cash-clock

      # Capacity status
      - name: "Capaciteit Status"
        unique_id: capacity_status
        state: >
          {% set current = states('sensor.eth_dongle_pro_power_delivered')|float(0) %}
          {% set warning = states('input_number.capacity_warning_threshold')|float(4200) %}
          {% set critical = states('input_number.capacity_critical_threshold')|float(4400) %}
          {% if current < warning %}
            veilig
          {% elif current < critical %}
            waarschuwing
          {% else %}
            kritiek
          {% endif %}
        icon: >
          {% set current = states('sensor.eth_dongle_pro_power_delivered')|float(0) %}
          {% set warning = states('input_number.capacity_warning_threshold')|float(4200) %}
          {% set critical = states('input_number.capacity_critical_threshold')|float(4400) %}
          {% if current < warning %}
            mdi:shield-check
          {% elif current < critical %}
            mdi:shield-alert
          {% else %}
            mdi:shield-remove
          {% endif %}

      # Total smart appliances power
      - name: "Totaal Slimme Apparaten Verbruik"
        unique_id: total_smart_appliances_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set vaatwas = states('sensor.vaatwas_power')|float(0) %}
          {% set wasmachine = states('sensor.wasmachine_power')|float(0) %}
          {% set droogkast = states('sensor.droogkast_power')|float(0) %}
          {{ (vaatwas + wasmachine + droogkast)|round(1) }}
        icon: mdi:washing-machine

      # Non-smart appliances power
      - name: "Niet-Slimme Apparaten Verbruik"
        unique_id: non_smart_appliances_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set totaal = states('sensor.eth_dongle_pro_power_delivered')|float(0) %}
          {% set slim = states('sensor.totaal_slimme_apparaten_verbruik')|float(0) %}
          {{ (totaal - slim)|round(1) }}
        icon: mdi:home-lightning-bolt

      # Start permission sensors
      - name: "Kan Wasmachine Starten"
        unique_id: kan_wasmachine_starten
        state: >
          {% set beschikbaar = states('sensor.beschikbaar_vermogen') | float(0) %}
          {% set nodig = states('input_number.washing_machine_power_usage') | float(2200) %}
          {% set piek_block = is_state('input_boolean.piek_blokkering', 'on') %}
          {% set cycle_active = is_state('input_boolean.washing_machine_cycle_active', 'on') %}
          {% if cycle_active %}
            nee
          {% elif piek_block %}
            nee
          {% elif beschikbaar > nodig %}
            ja
          {% else %}
            nee
          {% endif %}
        icon: >
          {% if states('sensor.kan_wasmachine_starten') == 'ja' %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

      - name: "Kan Droogkast Starten"
        unique_id: kan_droogkast_starten
        state: >
          {% set beschikbaar = states('sensor.beschikbaar_vermogen') | float(0) %}
          {% set nodig = states('input_number.dryer_power_usage') | float(2800) %}
          {% set piek_block = is_state('input_boolean.piek_blokkering', 'on') %}
          {% set cycle_active = is_state('input_boolean.dryer_cycle_active', 'on') %}
          {% if cycle_active %}
            nee
          {% elif piek_block %}
            nee
          {% elif beschikbaar > nodig %}
            ja
          {% else %}
            nee
          {% endif %}
        icon: >
          {% if states('sensor.kan_droogkast_starten') == 'ja' %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

      - name: "Kan Vaatwasser Starten"
        unique_id: kan_vaatwasser_starten
        state: >
          {% set beschikbaar = states('sensor.beschikbaar_vermogen') | float(0) %}
          {% set nodig = states('input_number.dishwasher_power_usage') | float(2000) %}
          {% set piek_block = is_state('input_boolean.piek_blokkering', 'on') %}
          {% set cycle_active = is_state('input_boolean.dishwasher_cycle_active', 'on') %}
          {% if cycle_active %}
            nee
          {% elif piek_block %}
            nee
          {% elif beschikbaar > nodig %}
            ja
          {% else %}
            nee
          {% endif %}
        icon: >
          {% if states('sensor.kan_vaatwasser_starten') == 'ja' %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

      - name: "Kan Nieuw Apparaat Starten"
        unique_id: kan_nieuw_apparaat_starten
        state: >
          {% set beschikbaar = states('sensor.beschikbaar_vermogen') | float(0) %}
          {% set min_apparaat = 2000 %}
          {% set piek_block = is_state('input_boolean.piek_blokkering', 'on') %}
          {% if piek_block %}
            nee
          {% elif beschikbaar > min_apparaat %}
            ja
          {% else %}
            nee
          {% endif %}
        icon: >
          {% if states('sensor.kan_nieuw_apparaat_starten') == 'ja' %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

# ========================================
# SWITCH TEMPLATES
# ========================================
switch:
  - platform: template
    switches:
      wallbox_laden:
        friendly_name: "Wallbox Pauzeren/Hervatten"
        value_template: "{{ is_state('switch.wallbox_kristof_riebbels_pauzeren_hervatten', 'on') }}"
        turn_on:
          service: switch.turn_on
          target:
            entity_id: switch.wallbox_kristof_riebbels_pauzeren_hervatten
        turn_off:
          service: switch.turn_off
          target:
            entity_id: switch.wallbox_kristof_riebbels_pauzeren_hervatten

# ========================================
# AUTOMATIONS - TARIFF MANAGEMENT
# ========================================
automation:
  # Tariff scheduler - weekdays
  - id: update_tariff_workdays
    alias: "Update elektriciteitstarief - werkdagen"
    description: "Zet het tarief automatisch op basis van uren schema (ma-vr)"
    trigger:
      - platform: time
        at: "01:00:00"
      - platform: time
        at: "07:00:00"
      - platform: time
        at: "11:00:00"
      - platform: time
        at: "17:00:00"
      - platform: time
        at: "22:00:00"
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.electricity_tariff_block
        data:
          option: >
            {% set h = now().hour %}
            {% if h == 1 or h >= 22 %}
              dal
            {% elif h >= 7 and h < 11 %}
              piek
            {% elif h >= 11 and h < 17 %}
              dal
            {% elif h >= 17 and h < 22 %}
              piek
            {% else %}
              dal
            {% endif %}

  - id: update_tariff_weekend
    alias: "Update elektriciteitstarief - weekend"
    description: "Zet het tarief automatisch op basis van uren schema (za-zo)"
    trigger:
      - platform: time
        at: "01:00:00"
      - platform: time
        at: "07:00:00"
      - platform: time
        at: "11:00:00"
      - platform: time
        at: "17:00:00"
      - platform: time
        at: "22:00:00"
    condition:
      - condition: time
        weekday:
          - sat
          - sun
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.electricity_tariff_block
        data:
          option: >
            {% set h = now().hour %}
            {% if h == 1 or h >= 22 %}
              dal
            {% elif h >= 7 and h < 11 %}
              superdal
            {% elif h >= 11 and h < 17 %}
              dal
            {% elif h >= 17 and h < 22 %}
              piek
            {% else %}
              dal
            {% endif %}

# ========================================
# AUTOMATIONS - WALLBOX CONTROL
# ========================================
  - id: wallbox_laden_bij_dal
    alias: "Wallbox Laden bij lage Fluvius-tarief"
    description: "Start wallbox bij dal/super dal tarief"
    trigger:
      - platform: state
        entity_id: sensor.fluvius_tarief
        to: "Dal"
      - platform: state
        entity_id: sensor.fluvius_tarief
        to: "Super Dal"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.wallbox_laden

  - id: wallbox_pauze_bij_piek
    alias: "Wallbox Pauze bij Piek"
    description: "Pauzeer wallbox bij piek tarief"
    trigger:
      - platform: state
        entity_id: sensor.fluvius_tarief
        to: "Piek"
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.wallbox_laden

# ========================================
# AUTOMATIONS - CAPACITY PROTECTION
# ========================================
  - id: capacity_protection_smart_devices
    alias: "Capaciteitsbescherming Slimme Apparaten"
    description: "Schakelt slimme apparaten uit bij overschrijding"
    trigger:
      - platform: numeric_state
        entity_id: sensor.eth_dongle_pro_power_delivered
        above: input_number.capacity_warning_threshold
        for: "00:00:30"
    condition:
      - condition: state
        entity_id: input_boolean.capacity_protection_active
        state: 'on'
    action:
      - choose:
          # Wasmachine (als niet bijna klaar)
          - conditions:
              - condition: state
                entity_id: switch.wasmachine_inschakelen
                state: 'on'
              - condition: template
                value_template: >
                  {% if has_value('sensor.wasmachine_programma_voortgang') %}
                    {% set progress = states('sensor.wasmachine_programma_voortgang')|int(0) %}
                    {{ progress < 85 }}
                  {% else %}
                    true
                  {% endif %}
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.wasmachine_inschakelen
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.washing_machine_interrupted
              - service: notify.persistent_notification
                data:
                  title: "ðŸ§º Wasmachine veilig onderbroken"
                  message: >
                    Capaciteit: {{ states('sensor.eth_dongle_pro_power_delivered') }}W
                    Herstart automatisch wanneer veilig

          # Droogkast
          - conditions:
              - condition: state
                entity_id: switch.droogkast
                state: 'on'
              - condition: numeric_state
                entity_id: sensor.droogkast_power
                above: 500
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.droogkast
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.dryer_interrupted
              - service: notify.persistent_notification
                data:
                  title: "ðŸŒ€ Droogkast veilig onderbroken"
                  message: "Herstart automatisch wanneer capaciteit beschikbaar"
        default:
          - service: notify.persistent_notification
            data:
              title: "âš ï¸ HANDMATIGE ACTIE VEREIST"
              message: >
                ðŸš¨ Verbruik: {{ states('sensor.eth_dongle_pro_power_delivered') }}W
                
                Alle slimme apparaten zijn veilig bezig.
                Niet-slimme apparaten: ~{{ states('sensor.niet_slimme_apparaten_verbruik') }}W
                
                ðŸ’¡ Zet handmatig grote apparaten uit!

  # Emergency alert
  - id: emergency_capacity_alert
    alias: "Noodwaarschuwing Extreme Capaciteit"
    description: "Kritieke waarschuwing bij gevaarlijke overschrijding"
    trigger:
      - platform: numeric_state
        entity_id: sensor.eth_dongle_pro_power_delivered
        above: input_number.capacity_critical_threshold
        for: "00:00:10"
    action:
      - service: notify.persistent_notification
        data:
          title: "ðŸš¨ KRITIEKE OVERSCHRIJDING!"
          message: >
            {{ states('sensor.eth_dongle_pro_power_delivered') }}W > {{ states('input_number.capacity_critical_threshold') }}W
            DIRECT HANDMATIG INGRIJPEN!

  # Auto resume interrupted appliances
  - id: auto_resume_safe_appliances
    alias: "Herstart Veilig Onderbroken Apparaten"
    description: "Start apparaten weer op als er ruimte is"
    trigger:
      - platform: numeric_state
        entity_id: sensor.eth_dongle_pro_power_delivered
        below: 2500
        for: "00:03:00"
    condition:
      - condition: template
        value_template: >
          {{ states('sensor.beschikbaar_vermogen')|float(0) > 2500 }}
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.washing_machine_interrupted
                state: 'on'
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.wasmachine_inschakelen
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.washing_machine_interrupted
              - service: notify.persistent_notification
                data:
                  title: "ðŸ”„ Wasmachine hervat"
                  message: "Automatisch herstart na capaciteitsonderbreking"

          - conditions:
              - condition: state
                entity_id: input_boolean.dryer_interrupted
                state: 'on'
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.droogkast
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.dryer_interrupted
              - service: notify.persistent_notification
                data:
                  title: "ðŸŒ€ Droogkast hervat"
                  message: "Was kan verder drogen"

# ========================================
# AUTOMATIONS - DYNAMIC CAPACITY LIMITS
# ========================================
  - id: high_power_warning
    alias: "Hoog verbruik waarschuwing"
    description: "Waarschuwt bij hoog totaalverbruik"
    trigger:
      - platform: numeric_state
        entity_id: sensor.eth_dongle_pro_power_delivered
        above: input_number.max_house_power
        for: "00:01:00"
    action:
      - service: notify.persistent_notification
        data:
          title: "âš¡ Hoog energieverbruik"
          message: >
            Totaalverbruik: {{ states('sensor.eth_dongle_pro_power_delivered') }}W 
            (limiet: {{ states('input_number.max_house_power') }}W)
            
            Actieve apparaten:
            {% if is_state('input_boolean.dishwasher_cycle_active', 'on') %}
            - Vaatwasser: {{ states('sensor.vaatwas_power') }}W
            {% endif %}
            {% if is_state('input_boolean.washing_machine_cycle_active', 'on') %}
            - Wasmachine: {{ states('sensor.wasmachine_power') }}W
            {% endif %}
            {% if is_state('input_boolean.dryer_cycle_active', 'on') %}
            - Droogkast: {{ states('sensor.droogkast_power') }}W
            {% endif %}

  - id: off_peak_capacity_adjustment
    alias: "Dal-uren capaciteitsaanpassing"
    description: "Verhoog capaciteitslimiet tijdens dal-uren"
    trigger:
      - platform: time
        at: "23:00:00"
      - platform: time
        at: "07:00:00"
    action:
      - choose:
          - conditions:
              - condition: time
                after: "23:00:00"
                before: "07:00:00"
            sequence:
              - service: input_number.set_value
                target:
                  entity_id: input_number.max_house_power
                data:
                  value: 6000
              - service: notify.persistent_notification
                data:
                  title: "ðŸŒ™ Dal-uren actief"
                  message: "Capaciteitslimiet verhoogd naar 6000W"
        default:
          - service: input_number.set_value
            target:
              entity_id: input_number.max_house_power
            data:
              value: 4000
          - service: notify.persistent_notification
            data:
              title: "â˜€ï¸ Piek-uren actief"
              message: "Capaciteitslimiet terug naar 4000W"

# ========================================
# AUTOMATIONS - PIEK BLOKKERING
# ========================================
  - id: piek_blokkering_activeren
    alias: "Piek Tarief Blokkering Activeren"
    trigger:
      - platform: state
        entity_id: input_select.electricity_tariff_block
        to: "piek"
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.piek_blokkering
      - service: notify.persistent_notification
        data:
          title: "âš¡ PIEK TARIEF ACTIEF"
          message: "Nieuwe apparaat starts zijn geblokkeerd"
          
  - id: piek_blokkering_deactiveren
    alias: "Piek Tarief Blokkering Deactiveren"
    trigger:
      - platform: state
        entity_id: input_select.electricity_tariff_block
        to: "dal"
      - platform: state
        entity_id: input_select.electricity_tariff_block
        to: "superdal"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.piek_blokkering

# ========================================
# APPLIANCE CYCLE DETECTION
# ========================================
  - id: wasmachine_cyclus_detectie
    alias: "Wasmachine Cyclus Detectie"
    trigger:
      - platform: numeric_state
        entity_id: sensor.wasmachine_power
        above: 50
        for: "00:01:00"
      - platform: numeric_state
        entity_id: sensor.wasmachine_power
        below: 10
        for: "00:02:00"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.wasmachine_power
                above: 50
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.washing_machine_cycle_active
              - service: notify.persistent_notification
                data:
                  title: "ðŸ§º Wasmachine gestart"
                  message: "Cyclus gedetecteerd - {{ states('sensor.wasmachine_power') }}W"
        default:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.washing_machine_cycle_active
          - service: notify.persistent_notification
            data:
              title: "âœ… Wasmachine klaar"
              message: "Cyclus voltooid"

  - id: droogkast_cyclus_detectie
    alias: "Droogkast Cyclus Detectie"
    trigger:
      - platform: numeric_state
        entity_id: sensor.droogkast_power
        above: 100
        for: "00:01:00"
      - platform: numeric_state
        entity_id: sensor.droogkast_power
        below: 20
        for: "00:02:00"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.droogkast_power
                above: 100
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.dryer_cycle_active
              - service: notify.persistent_notification
                data:
                  title: "ðŸŒ€ Droogkast gestart"
                  message: "Cyclus gedetecteerd - {{ states('sensor.droogkast_power') }}W"
        default:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.dryer_cycle_active
          - service: notify.persistent_notification
            data:
              title: "âœ… Droogkast klaar"
              message: "Droogcyclus voltooid"

  - id: vaatwasser_cyclus_detectie
    alias: "Vaatwasser Cyclus Detectie"
    trigger:
      - platform: numeric_state
        entity_id: sensor.vaatwas_power
        above: 50
        for: "00:01:00"
      - platform: numeric_state
        entity_id: sensor.vaatwas_power
        below: 10
        for: "00:02:00"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.vaatwas_power
                above: 50
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.dishwasher_cycle_active
              - service: notify.persistent_notification
                data:
                  title: "ðŸ½ï¸ Vaatwasser gestart"
                  message: "Cyclus gedetecteerd - {{ states('sensor.vaatwas_power') }}W"
        default:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.dishwasher_cycle_active
          - service: notify.persistent_notification
            data:
              title: "âœ… Vaatwasser klaar"
              message: "Afwascyclus voltooid"

# ========================================
# WACHTRIJ PROCESSING
# ========================================
  - id: wachtrij_processing_dal
    alias: "Verwerk Wachtrij bij Dal Tarief"
    description: "Start apparaten uit wachtrij tijdens dal tarieven"
    trigger:
      - platform: state
        entity_id: input_select.electricity_tariff_block
        to: "dal"
      - platform: state
        entity_id: input_select.electricity_tariff_block
        to: "superdal"
    condition:
      - condition: template
        value_template: >
          {{ states('sensor.kan_nieuw_apparaat_starten') == 'ja' }}
    action:
      # Check en start vaatwasser (laagste vermogen eerst)
      - if:
          - condition: state
            entity_id: input_boolean.vaatwasser_wachtrij
            state: "on"
          - condition: template
            value_template: >
              {% set beschikbaar = states('sensor.beschikbaar_vermogen') | float(0) %}
              {% set nodig = states('input_number.dishwasher_power_usage') | float(2000) %}
              {{ beschikbaar > nodig }}
        then:
          - service: switch.turn_on
            target:
              entity_id: switch.vaatwas
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.vaatwasser_wachtrij
          - service: notify.persistent_notification
            data:
              title: "âœ… Vaatwasser gestart vanuit wachtrij"
              message: "Dal tarief actief"

      # Check en start wasmachine  
      - if:
          - condition: state
            entity_id: input_boolean.wasmachine_wachtrij
            state: "on"
          - condition: template
            value_template: >
              {% set beschikbaar = states('sensor.beschikbaar_vermogen') | float(0) %}
              {% set nodig = states('input_number.washing_machine_power_usage') | float(2200) %}
              {{ beschikbaar > nodig }}
        then:
          - service: switch.turn_on
            target:
              entity_id: switch.wasmachine_inschakelen
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.wasmachine_wachtrij
          - service: notify.persistent_notification
            data:
              title: "âœ… Wasmachine gestart vanuit wachtrij"
              message: "Dal tarief actief"