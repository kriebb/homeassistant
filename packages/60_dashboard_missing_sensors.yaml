# Missing sensors for Energy Management dashboards
# This file creates all sensors referenced in the dashboards but not defined elsewhere

input_select:
  electricity_tariff_block:
    name: Elektriciteit tarief blok
    options:
      - Normaal
      - Piek
      - Dal
    initial: Normaal
    icon: mdi:clock-time-four

input_boolean:
  # Appliance auto mode controls
  dishwasher_auto_mode:
    name: Vaatwasser automatische modus
    initial: false
    icon: mdi:dishwasher
    
  washing_machine_auto_mode:
    name: Wasmachine automatische modus
    initial: false
    icon: mdi:washing-machine
    
  dryer_auto_mode:
    name: Droogkast automatische modus
    initial: false
    icon: mdi:tumble-dryer
    
  # Cycle tracking
  dishwasher_cycle_active:
    name: Vaatwasser cyclus actief
    initial: false
    
  washing_machine_cycle_active:
    name: Wasmachine cyclus actief
    initial: false
    
  dryer_cycle_active:
    name: Droogkast cyclus actief
    initial: false
    
  # Interruption tracking
  dishwasher_interrupted:
    name: Vaatwasser onderbroken
    initial: false
    
  washing_machine_interrupted:
    name: Wasmachine onderbroken
    initial: false
    
  dryer_interrupted:
    name: Droogkast onderbroken
    initial: false
    
  # Peak blocking
  witgoed_piek_blokkering_actief:
    name: Witgoed piek blokkering actief
    initial: false
    icon: mdi:block-helper

template:
  - sensor:
      # Daily energy consumption sensor (referenced in dashboard)
      - name: "Daily energy consumption"
        unique_id: daily_energy_consumption
        state: >
          {% set delivered = states('sensor.eth_dongle_pro_energy_delivered_daily') | float(0) %}
          {% set returned = states('sensor.eth_dongle_pro_energy_returned_daily') | float(0) %}
          {{ (delivered - returned) | round(2) }}
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        availability: >
          {{ states('sensor.eth_dongle_pro_energy_delivered_daily') not in ['unknown', 'unavailable', None] }}
          
      # Daily energy cost (was incorrectly in dashboard file)
      - name: "Daily energy cost"
        unique_id: daily_energy_cost  
        state: >
          {% set consumption = states('sensor.daily_energy_consumption') | float(0) %}
          {% set price_per_kwh = 0.25 %}
          {{ (consumption * price_per_kwh) | round(2) }}
        unit_of_measurement: "â‚¬"
        device_class: monetary
        
      # Tariff status for Simple Energy dashboard
      - name: "Tarief status"
        unique_id: tarief_status
        state: >
          {% set hour = now().hour %}
          {% if 7 <= hour < 21 %}
            Dag tarief
          {% else %}
            Nacht tarief
          {% endif %}
        attributes:
          info: "Energie.be heeft geen dag/nacht verschil"
          
      - name: "Volgende tarief wijziging"
        unique_id: volgende_tarief_wijziging
        state: >
          {% set hour = now().hour %}
          {% if hour < 7 %}
            {{ (today_at("07:00") - now()).total_seconds() // 3600 }} uur
          {% elif hour < 21 %}
            {{ (today_at("21:00") - now()).total_seconds() // 3600 }} uur
          {% else %}
            {{ ((today_at("07:00") + timedelta(days=1)) - now()).total_seconds() // 3600 }} uur
          {% endif %}
          
  - binary_sensor:
      # Peak/off-peak indicators
      - name: "Piek tarief actief"
        unique_id: piek_tarief_actief
        state: >
          {% set hour = now().hour %}
          {{ 17 <= hour < 20 }}
          
      - name: "Super dal tarief actief"
        unique_id: super_dal_tarief_actief
        state: >
          {% set hour = now().hour %}
          {{ 0 <= hour < 6 }}

# Move the toggle script from dashboard to here
script:
  toggle_all_auto_modes:
    alias: Toggle All Auto Modes
    sequence:
      - variables:
          current_state: >
            {{ is_state('input_boolean.dishwasher_auto_mode', 'on') or
               is_state('input_boolean.washing_machine_auto_mode', 'on') or
               is_state('input_boolean.dryer_auto_mode', 'on') }}
      - service: input_boolean.turn_{{ 'off' if current_state else 'on' }}
        target:
          entity_id:
            - input_boolean.dishwasher_auto_mode
            - input_boolean.washing_machine_auto_mode
            - input_boolean.dryer_auto_mode