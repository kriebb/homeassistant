# Capaciteitstarief Dashboard
# Monitor je maandpieken en voorkom onnodige kosten

views:
  - title: Capaciteitstarief
    path: capaciteit-starief
    icon: mdi:gauge
    cards:
      # Header met actuele status
      - type: custom:mushroom-title-card
        title: Capaciteitstarief Monitor
        subtitle: Beheer je maandpieken slim
        
      # Actuele capaciteit gauge
      - type: gauge
        entity: sensor.house_net_power
        name: Huidig Verbruik
        unit: W
        min: 0
        max: 8000
        needle: true
        severity:
          green: 0
          yellow: 3500
          red: 4362
        segments:
          - from: 0
            color: '#44ff44'
          - from: 3000
            color: '#ffff44'
          - from: 4362
            color: '#ff9944'
          - from: 5000
            color: '#ff4444'
            
      # Status overzicht
      - type: entities
        title: Capaciteit Status
        entities:
          - entity: sensor.capacity_status
            name: Status
          - entity: sensor.capacity_percentage
            name: Percentage in gebruik
          - entity: sensor.available_capacity
            name: Beschikbare capaciteit
            
      # Piekwaardes overzicht
      - type: entities
        title: Piekwaardes
        entities:
          - entity: sensor.home_import_power_peak_31d
            name: Huidige Maandpiek (31 dagen)
            icon: mdi:arrow-up-bold
          - entity: sensor.fluvius_capacity_limit
            name: Capaciteitslimiet
            icon: mdi:gauge-empty
          - entity: binary_sensor.new_month_peak_warning
            name: Nieuwe piek waarschuwing
            
      # Kosten berekening
      - type: custom:mushroom-template-card
        primary: Capaciteitstarief Kost
        secondary: "â‚¬{{ states('sensor.capacity_tariff_cost') | round(2) }}/maand"
        icon: mdi:cash
        icon_color: >
          {% set kw = states('sensor.home_import_power_peak_31d') | float(0) / 1000 %}
          {% if kw < 4 %} green
          {% elif kw < 5 %} yellow
          {% elif kw < 6 %} orange
          {% else %} red
          {% endif %}
        badge_icon: >
          {% if is_state('binary_sensor.new_month_peak_warning', 'on') %}
            mdi:alert
          {% endif %}
        badge_color: red
        
      # Historie grafiek
      - type: custom:apexcharts-card
        header:
          show: true
          title: Piekverloop Laatste 24u
        graph_span: 24h
        update_interval: 1min
        series:
          - entity: sensor.house_net_power
            name: Verbruik
            type: line
            color: blue
            group_by:
              func: max
              duration: 15min
          - entity: sensor.home_import_power_peak_31d
            name: Maandpiek
            type: line
            color: red
            stroke_width: 2
        yaxis:
          - min: 0
            max: ~6000
            decimals: 0
            apex_config:
              title:
                text: Vermogen (W)
                
      # Dagen tot reset
      - type: entities
        entities:
          - entity: sensor.dagen_tot_piek_reset
            name: Dagen tot piek reset
            icon: mdi:calendar-clock
                
      # Tips card
      - type: markdown
        content: |
          ## ðŸ’¡ Tips Capaciteitstarief
          
          **Huidige situatie:**
          - Maandpiek: **{{ (states('sensor.home_import_power_peak_31d') | float(0) / 1000) | round(2) }} kW**
          - Kost: **â‚¬{{ states('sensor.capacity_tariff_cost') | round(2) }}/maand**
          
          **Bespaar tips:**
          1. Blijf onder je huidige piek - geen extra kosten
          2. Elke kW extra = â‚¬{{ states('input_number.capacity_tariff_price') | float(3) }} Ã— 12 maanden
          3. Start zware verbruikers gespreid
          4. Laad je EV wanneer andere apparaten uit zijn